<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LangGraph Planner & Validator Nodes Explained</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .section {
            margin-bottom: 50px;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .section h2 {
            color: #2a5298;
            font-size: 2em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .section h3 {
            color: #764ba2;
            font-size: 1.5em;
            margin: 25px 0 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .icon {
            font-size: 1.5em;
        }

        .workflow-diagram {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
        }

        .flow-step {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 10px;
            position: relative;
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }

        .flow-step:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .flow-step::after {
            content: '‚Üì';
            position: absolute;
            bottom: -35px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2em;
            color: #667eea;
        }

        .flow-step:last-child::after {
            content: '';
        }

        .flow-step h4 {
            font-size: 1.3em;
            margin-bottom: 10px;
        }

        .flow-step p {
            opacity: 0.95;
            font-size: 1em;
        }

        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.5;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .code-comment {
            color: #6272a4;
        }

        .code-keyword {
            color: #ff79c6;
        }

        .code-function {
            color: #50fa7b;
        }

        .code-string {
            color: #f1fa8c;
        }

        .example-box {
            background: white;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .example-box h4 {
            color: #2a5298;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .feature-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .feature-card h4 {
            color: #667eea;
            font-size: 1.3em;
            margin-bottom: 10px;
        }

        .badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            margin: 5px;
        }

        .badge-planner {
            background: #667eea;
            color: white;
        }

        .badge-validator {
            background: #764ba2;
            color: white;
        }

        .badge-success {
            background: #10b981;
            color: white;
        }

        .badge-warning {
            background: #f59e0b;
            color: white;
        }

        .badge-error {
            background: #ef4444;
            color: white;
        }

        .decision-tree {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .decision-node {
            background: #f0f9ff;
            border: 2px solid #667eea;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            position: relative;
        }

        .decision-node.yes {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .decision-node.no {
            border-color: #ef4444;
            background: #fef2f2;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: bold;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #e5e7eb;
        }

        tr:hover {
            background: #f9fafb;
        }

        .interactive-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 10px 5px;
        }

        .interactive-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .interactive-demo {
            background: #f0f9ff;
            padding: 25px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .demo-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 1em;
            margin: 10px 0;
        }

        .demo-output {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            min-height: 100px;
            border: 2px solid #e5e7eb;
        }

        footer {
            background: #1f2937;
            color: white;
            text-align: center;
            padding: 30px;
            margin-top: 50px;
        }

        .highlight {
            background: #fef3c7;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section {
            animation: fadeIn 0.6s ease-out;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üß† LangGraph Planner & Validator Nodes</h1>
            <p>Complete Technical Deep-Dive with Interactive Examples</p>
        </header>

        <div class="content">
            <!-- OVERVIEW SECTION -->
            <div class="section">
                <h2><span class="icon">üìã</span> Executive Overview</h2>
                <p>The <strong>Planner Node</strong> and <strong>Validator Node</strong> are two critical components in your LangGraph workflow that act as the "brain" and "quality control" of your portfolio intelligence system.</p>
                
                <div class="feature-grid">
                    <div class="feature-card">
                        <h4>üéØ Planner Node</h4>
                        <p><strong>Role:</strong> Query Analyzer & Workflow Orchestrator</p>
                        <p><strong>Purpose:</strong> Interprets user questions and decides which agents to activate</p>
                        <span class="badge badge-planner">First Agent</span>
                        <span class="badge badge-success">Decision Maker</span>
                    </div>

                    <div class="feature-card">
                        <h4>‚úÖ Validator Node</h4>
                        <p><strong>Role:</strong> Quality Assurance & Fact Checker</p>
                        <p><strong>Purpose:</strong> Ensures responses are accurate and grounded in real data</p>
                        <span class="badge badge-validator">Last Agent</span>
                        <span class="badge badge-warning">Quality Control</span>
                    </div>
                </div>
            </div>

            <!-- PLANNER NODE DETAILED SECTION -->
            <div class="section">
                <h2><span class="icon">üéØ</span> Planner Node - The Query Interpreter</h2>
                
                <h3>üîç What Does the Planner Node Do?</h3>
                <p>The Planner Node is the <span class="highlight">FIRST agent</span> in your workflow. It analyzes the user's query and makes three critical decisions:</p>

                <div class="workflow-diagram">
                    <div class="flow-step">
                        <h4>Step 1: Context Understanding</h4>
                        <p>Analyzes the current query + conversation history to understand what the user is REALLY asking</p>
                    </div>

                    <div class="flow-step">
                        <h4>Step 2: Data Requirements Analysis</h4>
                        <p>Determines if we need Portfolio Data, Market Data, or both</p>
                    </div>

                    <div class="flow-step">
                        <h4>Step 3: Intent Classification</h4>
                        <p>Decides if user wants information only OR investment recommendations</p>
                    </div>

                    <div class="flow-step">
                        <h4>Step 4: Agent Activation</h4>
                        <p>Sets flags to activate Portfolio Agent, Market Agent, or both</p>
                    </div>
                </div>

                <h3>üß© The Three Critical Decisions</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Decision</th>
                            <th>What It Means</th>
                            <th>Example Query</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>needs_portfolio = TRUE</strong></td>
                            <td>Activate Portfolio Agent to fetch user's holdings</td>
                            <td>"What stocks do I own?"</td>
                        </tr>
                        <tr>
                            <td><strong>needs_market = TRUE</strong></td>
                            <td>Activate Market Agent to fetch real-time prices/news</td>
                            <td>"What's the price of AAPL?"</td>
                        </tr>
                        <tr>
                            <td><strong>wants_recommendations = TRUE</strong></td>
                            <td>User wants advice, not just information</td>
                            <td>"How should I improve my portfolio?"</td>
                        </tr>
                    </tbody>
                </table>

                <h3>üí° Smart Context Understanding</h3>
                <p>The Planner is smart about understanding follow-up questions:</p>

                <div class="example-box">
                    <h4>Example Conversation:</h4>
                    <div class="code-block">
<span class="code-comment">// User's first query</span>
User: <span class="code-string">"What stocks do I own?"</span>
Assistant: <span class="code-string">"You own AAPL (50 shares), TSLA (30 shares), MSFT (40 shares)"</span>

<span class="code-comment">// User's follow-up (very short!)</span>
User: <span class="code-string">"Tell me more about the first one"</span>

<span class="code-comment">// ‚úÖ Planner UNDERSTANDS:</span>
<span class="code-comment">// - "first one" refers to AAPL from previous response</span>
<span class="code-comment">// - User wants MORE INFO about AAPL</span>
<span class="code-comment">// - Need BOTH portfolio (how many shares) AND market data (current price)</span>

<span class="code-keyword">decisions</span> = {
    <span class="code-function">needs_portfolio</span>: <span class="code-string">TRUE</span>,  <span class="code-comment">// Get AAPL holdings info</span>
    <span class="code-function">needs_market</span>: <span class="code-string">TRUE</span>,     <span class="code-comment">// Get AAPL current price</span>
    <span class="code-function">wants_recommendations</span>: <span class="code-string">FALSE</span> <span class="code-comment">// Just info, no advice</span>
}
                    </div>
                </div>

                <h3>üéì Query Classification Logic</h3>
                <div class="decision-tree">
                    <div class="decision-node">
                        <strong>Query contains:</strong> "what stocks", "my holdings", "what do I own"
                        <br>‚ûú <span class="badge badge-planner">Portfolio Data Only</span>
                    </div>

                    <div class="decision-node">
                        <strong>Query contains:</strong> "price of [stock]", "how is AAPL doing"
                        <br>‚ûú <span class="badge badge-planner">Market Data Only</span>
                    </div>

                    <div class="decision-node">
                        <strong>Query contains:</strong> "my AAPL stock", "my holdings performance"
                        <br>‚ûú <span class="badge badge-success">Both Portfolio + Market Data</span>
                    </div>

                    <div class="decision-node">
                        <strong>Query contains:</strong> "how to improve", "what should I do", "recommendations"
                        <br>‚ûú <span class="badge badge-warning">Data + Wants Advice = TRUE</span>
                    </div>
                </div>

                <h3>üìù Code Walkthrough - Planner Node</h3>
                <div class="code-block">
<span class="code-keyword">def</span> <span class="code-function">planner_node</span>(state: Dict) -> Dict:
    <span class="code-comment"># Extract user's query and conversation history</span>
    query = state.<span class="code-function">get</span>(<span class="code-string">"query"</span>, <span class="code-string">""</span>)
    conversation_history = state.<span class="code-function">get</span>(<span class="code-string">"conversation_history"</span>, [])
    
    <span class="code-comment"># üß† Build context from last 8 messages (4 exchanges)</span>
    history_context = <span class="code-string">""</span>
    <span class="code-keyword">if</span> conversation_history:
        <span class="code-keyword">for</span> msg <span class="code-keyword">in</span> conversation_history[-8:]:
            history_context += f<span class="code-string">"{msg['role']}: {msg['content']}\n"</span>
    
    <span class="code-comment"># ü§ñ Create intelligent prompt for LLM</span>
    planning_prompt = f<span class="code-string">"""
    You are a planning agent analyzing this query:
    User Query: "{query}"
    Previous Conversation: {history_context}
    
    ANALYZE:
    1. What is user REALLY asking? (combine current + history)
    2. Do we need portfolio data? (user's stocks, holdings)
    3. Do we need market data? (current prices, news)
    4. Does user want recommendations? (advice vs just info)
    
    Respond with:
    Portfolio Data Needed: YES or NO
    Market Data Needed: YES or NO
    Wants Recommendations: YES or NO
    """</span>
    
    <span class="code-comment"># üîÆ Get LLM decision</span>
    llm = <span class="code-function">get_llm</span>(temperature=0.3)  <span class="code-comment"># Low temp = consistent decisions</span>
    response = llm.<span class="code-function">invoke</span>(planning_prompt)
    plan = response.content
    
    <span class="code-comment"># üìä Parse LLM response to extract decisions</span>
    needs_portfolio = <span class="code-string">"Portfolio Data Needed: YES"</span> <span class="code-keyword">in</span> plan
    needs_market = <span class="code-string">"Market Data Needed: YES"</span> <span class="code-keyword">in</span> plan
    wants_recommendations = <span class="code-string">"Wants Recommendations: YES"</span> <span class="code-keyword">in</span> plan
    
    <span class="code-comment"># ‚úÖ Return updated state with decisions</span>
    <span class="code-keyword">return</span> {
        **state,
        <span class="code-string">"plan"</span>: plan,
        <span class="code-string">"needs_portfolio"</span>: needs_portfolio,
        <span class="code-string">"needs_market"</span>: needs_market,
        <span class="code-string">"wants_recommendations"</span>: wants_recommendations
    }
                </div>

                <h3>üéØ Real-World Examples</h3>
                <div class="example-box">
                    <h4>Example 1: Portfolio Query</h4>
                    <strong>User:</strong> "What stocks do I own?"<br>
                    <strong>Planner Decision:</strong><br>
                    <span class="badge badge-success">needs_portfolio = TRUE</span>
                    <span class="badge badge-error">needs_market = FALSE</span>
                    <span class="badge badge-error">wants_recommendations = FALSE</span><br>
                    <strong>Result:</strong> Only Portfolio Agent is activated
                </div>

                <div class="example-box">
                    <h4>Example 2: Market Query</h4>
                    <strong>User:</strong> "What's the current price of Tesla stock?"<br>
                    <strong>Planner Decision:</strong><br>
                    <span class="badge badge-error">needs_portfolio = FALSE</span>
                    <span class="badge badge-success">needs_market = TRUE</span>
                    <span class="badge badge-error">wants_recommendations = FALSE</span><br>
                    <strong>Result:</strong> Only Market Agent is activated
                </div>

                <div class="example-box">
                    <h4>Example 3: Combined Query with Advice</h4>
                    <strong>User:</strong> "How should I improve my portfolio?"<br>
                    <strong>Planner Decision:</strong><br>
                    <span class="badge badge-success">needs_portfolio = TRUE</span>
                    <span class="badge badge-success">needs_market = TRUE</span>
                    <span class="badge badge-warning">wants_recommendations = TRUE</span><br>
                    <strong>Result:</strong> Both agents activated + recommendation mode enabled
                </div>

                <h3>üõ†Ô∏è Planner Node Tools</h3>
                <p>The Planner Node <strong>doesn't use external tools</strong> - it relies entirely on the LLM's intelligence to classify queries. However, here's what it has access to:</p>

                <table>
                    <thead>
                        <tr>
                            <th>Resource</th>
                            <th>Purpose</th>
                            <th>How It's Used</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Conversation History</strong></td>
                            <td>Understand context from previous messages</td>
                            <td>Last 8 messages (4 Q&A pairs) are included in planning prompt</td>
                        </tr>
                        <tr>
                            <td><strong>LLM (GPT-4o-mini)</strong></td>
                            <td>Natural language understanding and classification</td>
                            <td>Analyzes query intent with temperature=0.3 for consistency</td>
                        </tr>
                        <tr>
                            <td><strong>Pattern Matching</strong></td>
                            <td>Parse LLM response to extract decisions</td>
                            <td>Looks for "YES/NO" patterns in LLM output</td>
                        </tr>
                    </tbody>
                </table>

                <div class="example-box">
                    <h4>üß† Why No External Tools?</h4>
                    <p>The Planner's job is <strong>pure decision-making</strong>, not data fetching. It doesn't need to:</p>
                    <ul style="list-style-position: inside; margin-left: 20px; margin-top: 10px;">
                        <li>‚ùå Load any files (that's Portfolio Agent's job)</li>
                        <li>‚ùå Call any APIs (that's Market Agent's job)</li>
                        <li>‚ùå Validate responses (that's Validator's job)</li>
                        <li>‚úÖ Just analyze the query and make routing decisions</li>
                    </ul>
                </div>
            </div>

            <!-- VALIDATOR NODE DETAILED SECTION -->
            <div class="section">
                <h2><span class="icon">‚úÖ</span> Validator Node - The Quality Guardian</h2>
                
                <h3>üõ°Ô∏è What Does the Validator Node Do?</h3>
                <p>The Validator Node is the <span class="highlight">LAST agent</span> in your workflow. It acts as quality control before sending the response to the user.</p>

                <div class="workflow-diagram">
                    <div class="flow-step">
                        <h4>Step 1: Ambiguity Detection</h4>
                        <p>Checks if the query was too vague and needs clarification</p>
                    </div>

                    <div class="flow-step">
                        <h4>Step 2: Data Sufficiency Check</h4>
                        <p>Verifies we have enough data to answer the question</p>
                    </div>

                    <div class="flow-step">
                        <h4>Step 3: Hallucination Detection</h4>
                        <p>Ensures the AI didn't make up facts not in the data</p>
                    </div>

                    <div class="flow-step">
                        <h4>Step 4: Response Enhancement</h4>
                        <p>Adds warnings or disclaimers if issues are detected</p>
                    </div>
                </div>

                <h3>üîç The Four Validation Checks</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Check Type</th>
                            <th>What It Detects</th>
                            <th>Action Taken</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Ambiguity Detection</strong></td>
                            <td>Vague queries like "best stock", "that one"</td>
                            <td>Request clarification from user</td>
                        </tr>
                        <tr>
                            <td><strong>Data Sufficiency</strong></td>
                            <td>Missing portfolio or market data</td>
                            <td>Inform user data is unavailable</td>
                        </tr>
                        <tr>
                            <td><strong>Hallucination Detection</strong></td>
                            <td>AI making up stocks, prices, or facts</td>
                            <td>Add warning to response</td>
                        </tr>
                        <tr>
                            <td><strong>Confidence Scoring</strong></td>
                            <td>Low confidence in response accuracy</td>
                            <td>Add disclaimer to response</td>
                        </tr>
                    </tbody>
                </table>

                <h3>üö® Ambiguity Detection Examples</h3>
                <div class="example-box">
                    <h4>Vague Pronoun Detection:</h4>
                    <div class="code-block">
User: <span class="code-string">"What's the price of it?"</span>

<span class="code-comment">// ‚ùå PROBLEM: What is "it"? No context!</span>

Validator detects: <span class="code-string">"it"</span> without clear antecedent
Response: <span class="code-string">"Which specific stock are you referring to when you say 'it'?"</span>
                    </div>
                </div>

                <div class="example-box">
                    <h4>Relative Terms Without Context:</h4>
                    <div class="code-block">
User: <span class="code-string">"Show me the best stock"</span>

<span class="code-comment">// ‚ùå PROBLEM: Best by what metric?</span>
<span class="code-comment">// - Highest return?</span>
<span class="code-comment">// - Highest value?</span>
<span class="code-comment">// - Lowest risk?</span>

Validator detects: <span class="code-string">"best"</span> without metric context
Response: <span class="code-string">"Best by what metric? (highest return, highest value, lowest risk?)"</span>
                    </div>
                </div>

                <h3>üî¨ Hallucination Detection</h3>
                <p>The validator checks if the AI is making up facts that don't exist in the actual data:</p>

                <div class="example-box">
                    <h4>Stock Hallucination:</h4>
                    <div class="code-block">
<span class="code-comment">// ACTUAL PORTFOLIO DATA:</span>
portfolio = {
    <span class="code-string">"holdings"</span>: [
        {<span class="code-string">"symbol"</span>: <span class="code-string">"AAPL"</span>, <span class="code-string">"shares"</span>: 50},
        {<span class="code-string">"symbol"</span>: <span class="code-string">"TSLA"</span>, <span class="code-string">"shares"</span>: 30}
    ]
}

<span class="code-comment">// AI RESPONSE:</span>
<span class="code-string">"You own AAPL, TSLA, and GOOGL stocks"</span>

<span class="code-comment">// ‚ùå HALLUCINATION DETECTED: GOOGL not in portfolio!</span>

Validator adds warning:
<span class="code-string">"‚ö†Ô∏è Warning: Response mentions stocks not found in portfolio data (GOOGL)"</span>
                    </div>
                </div>

                <div class="example-box">
                    <h4>Price Hallucination:</h4>
                    <div class="code-block">
<span class="code-comment">// ACTUAL MARKET DATA:</span>
market_data = {
    <span class="code-string">"AAPL"</span>: {<span class="code-string">"price"</span>: 175.50, <span class="code-string">"change"</span>: +2.30}
}

<span class="code-comment">// AI RESPONSE:</span>
<span class="code-string">"AAPL is trading at $185.00, up $5.50 today"</span>

<span class="code-comment">// ‚ùå HALLUCINATION: Price and change don't match data!</span>

Validator adds warning:
<span class="code-string">"‚ö†Ô∏è Warning: Price information may not match actual data"</span>
                    </div>
                </div>

                <h3>üìù Code Walkthrough - Validator Node</h3>
                <div class="code-block">
<span class="code-keyword">def</span> <span class="code-function">validator_node</span>(state: Dict) -> Dict:
    <span class="code-comment"># Extract query, response, and data</span>
    query = state.<span class="code-function">get</span>(<span class="code-string">"query"</span>, <span class="code-string">""</span>)
    response = state.<span class="code-function">get</span>(<span class="code-string">"response"</span>, <span class="code-string">""</span>)
    portfolio_data = state.<span class="code-function">get</span>(<span class="code-string">"portfolio_data"</span>, {})
    market_data = state.<span class="code-function">get</span>(<span class="code-string">"market_data"</span>, {})
    conversation_history = state.<span class="code-function">get</span>(<span class="code-string">"conversation_history"</span>, [])
    
    <span class="code-comment"># ===== CHECK 1: AMBIGUITY DETECTION =====</span>
    is_ambiguous, clarification_msg = <span class="code-function">detect_ambiguity</span>(query, conversation_history)
    
    <span class="code-keyword">if</span> is_ambiguous:
        <span class="code-comment"># Query too vague - ask user for clarification</span>
        <span class="code-keyword">return</span> {
            **state,
            <span class="code-string">"needs_clarification"</span>: <span class="code-keyword">True</span>,
            <span class="code-string">"clarification_message"</span>: clarification_msg,
            <span class="code-string">"validated"</span>: <span class="code-keyword">False</span>
        }
    
    <span class="code-comment"># ===== CHECK 2: DATA SUFFICIENCY =====</span>
    has_sufficient_data, insufficiency_msg = <span class="code-function">check_data_sufficiency</span>(
        query, portfolio_data, market_data
    )
    
    <span class="code-keyword">if</span> <span class="code-keyword">not</span> has_sufficient_data:
        <span class="code-comment"># Not enough data - tell user</span>
        <span class="code-keyword">return</span> {
            **state,
            <span class="code-string">"response"</span>: insufficiency_msg,
            <span class="code-string">"validated"</span>: <span class="code-keyword">True</span>
        }
    
    <span class="code-comment"># ===== CHECK 3: HALLUCINATION DETECTION =====</span>
    fact_check = <span class="code-function">enhanced_fact_check</span>(response, portfolio_data, market_data)
    
    <span class="code-keyword">if</span> fact_check[<span class="code-string">"has_hallucinations"</span>]:
        <span class="code-comment"># Add warning about detected hallucinations</span>
        enhanced_response = response + <span class="code-string">"\n\n---\n"</span>
        enhanced_response += <span class="code-string">"‚ö†Ô∏è Warning: Response validation detected issues:\n"</span>
        <span class="code-keyword">for</span> hallucination <span class="code-keyword">in</span> fact_check[<span class="code-string">"hallucinations"</span>]:
            enhanced_response += f<span class="code-string">"- {hallucination}\n"</span>
        
        <span class="code-keyword">return</span> {
            **state,
            <span class="code-string">"response"</span>: enhanced_response,
            <span class="code-string">"validated"</span>: <span class="code-keyword">True</span>
        }
    
    <span class="code-comment"># ===== CHECK 4: CONFIDENCE SCORING =====</span>
    validation_result = <span class="code-function">validate_response</span>(response, query, {
        <span class="code-string">"portfolio_data"</span>: portfolio_data,
        <span class="code-string">"market_data"</span>: market_data
    })
    
    confidence = validation_result[<span class="code-string">"confidence"</span>]
    
    <span class="code-keyword">if</span> confidence < 0.7:
        <span class="code-comment"># Low confidence - add disclaimer</span>
        enhanced_response = response + <span class="code-string">"\n\n---\n"</span>
        enhanced_response += <span class="code-string">"Note: This response may have limitations."</span>
        
        <span class="code-keyword">return</span> {
            **state,
            <span class="code-string">"response"</span>: enhanced_response,
            <span class="code-string">"validated"</span>: <span class="code-keyword">True</span>
        }
    
    <span class="code-comment"># ‚úÖ All checks passed - response is valid!</span>
    <span class="code-keyword">return</span> {
        **state,
        <span class="code-string">"validated"</span>: <span class="code-keyword">True</span>,
        <span class="code-string">"needs_clarification"</span>: <span class="code-keyword">False</span>
    }
                </div>

                <h3>üéØ Validator Decision Flow</h3>
                <div class="decision-tree">
                    <div class="decision-node">
                        <strong>Is query ambiguous?</strong> (vague pronouns, relative terms)
                        <br>‚ûú YES: <span class="badge badge-error">Request Clarification</span>
                        <br>‚ûú NO: Continue to next check
                    </div>

                    <div class="decision-node">
                        <strong>Do we have sufficient data?</strong> (portfolio + market data available)
                        <br>‚ûú NO: <span class="badge badge-error">Inform User Data Missing</span>
                        <br>‚ûú YES: Continue to next check
                    </div>

                    <div class="decision-node">
                        <strong>Does response contain hallucinations?</strong> (made-up facts)
                        <br>‚ûú YES: <span class="badge badge-warning">Add Warning to Response</span>
                        <br>‚ûú NO: Continue to next check
                    </div>

                    <div class="decision-node yes">
                        <strong>All checks passed!</strong>
                        <br>‚ûú <span class="badge badge-success">Response Validated ‚úì</span>
                    </div>
                </div>

                <h3>üõ†Ô∏è Validator Node Tools</h3>
                <p>The Validator Node uses <strong>4 specialized validation tools</strong> from <code>validator_tools.py</code>:</p>

                <div class="tool-card" style="background: linear-gradient(135deg, #fff5f7 0%, #ffe8ec 100%); padding: 20px; margin: 15px 0; border-radius: 10px; border-left: 5px solid #667eea;">
                    <h4 style="color: #764ba2; margin-bottom: 10px;">üîß Tool 1: detect_ambiguity()</h4>
                    <div style="background: #2d2d2d; color: #50fa7b; padding: 10px; border-radius: 5px; font-family: 'Courier New', monospace; font-size: 0.9em; margin: 10px 0;">
detect_ambiguity(query: str, conversation_history: List[Dict]) ‚Üí Tuple[bool, str]
                    </div>
                    <p><strong>Purpose:</strong> Detects vague or unclear queries that need clarification</p>
                    <p><strong>What It Checks:</strong></p>
                    <ul style="list-style-position: inside; margin-left: 20px;">
                        <li><strong>Vague pronouns:</strong> "it", "that stock", "that one", "this one"</li>
                        <li><strong>Relative terms:</strong> "best", "worst", "top", "most" (without context)</li>
                        <li><strong>Time references:</strong> "recent", "lately", "previously" (without timeframe)</li>
                        <li><strong>Incomplete comparisons:</strong> "compared to" without both items</li>
                    </ul>
                    <p><strong>Returns:</strong></p>
                    <ul style="list-style-position: inside; margin-left: 20px;">
                        <li><code>(True, "Which stock are you referring to?")</code> if ambiguous</li>
                        <li><code>(False, "")</code> if query is clear</li>
                    </ul>
                </div>

                <div class="tool-card" style="background: linear-gradient(135deg, #fff5f7 0%, #ffe8ec 100%); padding: 20px; margin: 15px 0; border-radius: 10px; border-left: 5px solid #667eea;">
                    <h4 style="color: #764ba2; margin-bottom: 10px;">üîß Tool 2: check_data_sufficiency()</h4>
                    <div style="background: #2d2d2d; color: #50fa7b; padding: 10px; border-radius: 5px; font-family: 'Courier New', monospace; font-size: 0.9em; margin: 10px 0;">
check_data_sufficiency(query: str, portfolio_data: Dict, market_data: Dict) ‚Üí Tuple[bool, str]
                    </div>
                    <p><strong>Purpose:</strong> Verifies we have enough data to answer the query</p>
                    <p><strong>What It Checks:</strong></p>
                    <ul style="list-style-position: inside; margin-left: 20px;">
                        <li><strong>Missing portfolio data:</strong> Query asks about holdings but no data loaded</li>
                        <li><strong>Missing market data:</strong> Query asks about prices but API unavailable</li>
                        <li><strong>Unknown tickers:</strong> User mentions stock not in portfolio or market data</li>
                    </ul>
                    <p><strong>Example Detection:</strong></p>
                    <div style="background: #f3f4f6; border: 2px dashed #667eea; padding: 15px; margin: 10px 0; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 0.9em;">
Query: "What's the price of XYZ?"
Portfolio: [AAPL, TSLA, MSFT]
Market Data: [AAPL, TSLA, MSFT]

Result: (False, "I don't have market data for XYZ. Would you like me to search for it?")
                    </div>
                </div>

                <div class="tool-card" style="background: linear-gradient(135deg, #fff5f7 0%, #ffe8ec 100%); padding: 20px; margin: 15px 0; border-radius: 10px; border-left: 5px solid #667eea;">
                    <h4 style="color: #764ba2; margin-bottom: 10px;">üîß Tool 3: enhanced_fact_check()</h4>
                    <div style="background: #2d2d2d; color: #50fa7b; padding: 10px; border-radius: 5px; font-family: 'Courier New', monospace; font-size: 0.9em; margin: 10px 0;">
enhanced_fact_check(response: str, portfolio_data: Dict, market_data: Dict) ‚Üí Dict
                    </div>
                    <p><strong>Purpose:</strong> Detects AI hallucinations (made-up facts not in data)</p>
                    <p><strong>What It Checks:</strong></p>
                    <ul style="list-style-position: inside; margin-left: 20px;">
                        <li><strong>Unknown tickers:</strong> Response mentions stocks not in any data source</li>
                        <li><strong>Price accuracy:</strong> Compares mentioned prices to actual market data (¬±50% tolerance)</li>
                        <li><strong>Contradictory percentages:</strong> Response has conflicting positive/negative changes</li>
                        <li><strong>Smart filtering:</strong> Ignores common English words that look like tickers (THE, AND, FOR, etc.)</li>
                    </ul>
                    <p><strong>Returns Dictionary:</strong></p>
                    <div style="background: #f3f4f6; border: 2px dashed #667eea; padding: 15px; margin: 10px 0; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 0.9em;">
{
    "hallucinations": ["Mentions GOOGL not in portfolio data"],
    "issues": ["Price for AAPL seems incorrect: mentioned $200, actual $175.50"],
    "has_hallucinations": True,
    "fact_check_passed": False
}
                    </div>
                </div>

                <div class="tool-card" style="background: linear-gradient(135deg, #fff5f7 0%, #ffe8ec 100%); padding: 20px; margin: 15px 0; border-radius: 10px; border-left: 5px solid #667eea;">
                    <h4 style="color: #764ba2; margin-bottom: 10px;">üîß Tool 4: validate_response()</h4>
                    <div style="background: #2d2d2d; color: #50fa7b; padding: 10px; border-radius: 5px; font-family: 'Courier New', monospace; font-size: 0.9em; margin: 10px 0;">
validate_response(response: str, query: str, data_sources: Dict) ‚Üí Dict
                    </div>
                    <p><strong>Purpose:</strong> Overall quality check with confidence scoring</p>
                    <p><strong>What It Checks:</strong></p>
                    <ul style="list-style-position: inside; margin-left: 20px;">
                        <li><strong>Response length:</strong> Too short = likely error</li>
                        <li><strong>Vague statements:</strong> "I don't have access", "I cannot see"</li>
                        <li><strong>Missing stock mentions:</strong> Portfolio query but no actual holdings referenced</li>
                        <li><strong>Missing numerical data:</strong> Price query but no numbers in response</li>
                    </ul>
                    <p><strong>Confidence Scoring:</strong></p>
                    <div style="background: #f3f4f6; border: 2px dashed #667eea; padding: 15px; margin: 10px 0; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 0.9em;">
Start: confidence = 1.0
-0.2 for vague phrases
-0.3 if no stock mentions when expected
-0.2 if no numbers in price query
-0.1 for potentially contradictory terms

Final: confidence = max(0.0, min(1.0, calculated_score))
Valid if confidence >= 0.5
                    </div>
                    <p><strong>Returns:</strong></p>
                    <div style="background: #f3f4f6; border: 2px dashed #667eea; padding: 15px; margin: 10px 0; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 0.9em;">
{
    "is_valid": True/False,
    "issues": ["List of detected issues"],
    "confidence": 0.85  # Range: 0.0 to 1.0
}
                    </div>
                </div>

                <h3>üìä Tool Execution Order</h3>
                <div class="workflow-diagram">
                    <div class="flow-step" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                        <h4>Tool 1: detect_ambiguity()</h4>
                        <p>‚úÖ Check if query is clear ‚Üí If ambiguous, stop and ask for clarification</p>
                    </div>

                    <div class="flow-step" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                        <h4>Tool 2: check_data_sufficiency()</h4>
                        <p>‚úÖ Check if we have required data ‚Üí If missing, stop and inform user</p>
                    </div>

                    <div class="flow-step" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                        <h4>Tool 3: enhanced_fact_check()</h4>
                        <p>‚úÖ Check for hallucinations ‚Üí If found, add warning to response</p>
                    </div>

                    <div class="flow-step" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                        <h4>Tool 4: validate_response()</h4>
                        <p>‚úÖ Overall quality check ‚Üí If low confidence, add disclaimer</p>
                    </div>
                </div>

                <div class="example-box">
                    <h4>üîç Real Example: Tool Execution</h4>
                    <strong>Query:</strong> "What's the price of NVDA?"<br>
                    <strong>Portfolio:</strong> AAPL, TSLA, MSFT<br>
                    <strong>Market Data:</strong> AAPL, TSLA, MSFT<br><br>
                    
                    <strong>Tool 1 (detect_ambiguity):</strong><br>
                    <span class="badge badge-success">PASS</span> - Query is clear<br><br>

                    <strong>Tool 2 (check_data_sufficiency):</strong><br>
                    <span class="badge badge-error">FAIL</span> - NVDA not in portfolio or market data<br>
                    <strong>Result:</strong> "I don't have market data for NVDA. Would you like me to search for it?"<br><br>

                    <strong>Tools 3 & 4:</strong> Not executed (stopped early)
                </div>
            </div>

            <!-- COMPLETE WORKFLOW SECTION -->
            <div class="section">
                <h2><span class="icon">üîÑ</span> Complete Workflow: Planner ‚Üí Agents ‚Üí Validator</h2>
                
                <div class="workflow-diagram">
                    <div class="flow-step" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                        <h4>1Ô∏è‚É£ User Query Arrives</h4>
                        <p>"What's my total portfolio value and how is it performing?"</p>
                    </div>

                    <div class="flow-step" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <h4>2Ô∏è‚É£ Planner Node Analyzes</h4>
                        <p>Decision: needs_portfolio=TRUE, needs_market=TRUE, wants_recommendations=FALSE</p>
                    </div>

                    <div class="flow-step" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                        <h4>3Ô∏è‚É£ Portfolio Agent Activated</h4>
                        <p>Fetches: AAPL (50 shares), TSLA (30 shares), total value $15,250</p>
                    </div>

                    <div class="flow-step" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);">
                        <h4>4Ô∏è‚É£ Market Agent Activated</h4>
                        <p>Fetches: AAPL price $175.50 (+2.3%), TSLA price $245.80 (-1.5%)</p>
                    </div>

                    <div class="flow-step" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                        <h4>5Ô∏è‚É£ Response Generated</h4>
                        <p>"Your portfolio value is $15,250. AAPL gained 2.3%, TSLA lost 1.5% today."</p>
                    </div>

                    <div class="flow-step" style="background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);">
                        <h4>6Ô∏è‚É£ Validator Node Checks</h4>
                        <p>‚úÖ Not ambiguous ‚úÖ Sufficient data ‚úÖ No hallucinations ‚úÖ High confidence</p>
                    </div>

                    <div class="flow-step" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                        <h4>7Ô∏è‚É£ Response Sent to User</h4>
                        <p>User receives validated, accurate response!</p>
                    </div>
                </div>
            </div>

            <!-- INTERACTIVE DEMO SECTION -->
            <div class="section">
                <h2><span class="icon">üéÆ</span> Interactive Demo</h2>
                <p>Try different queries to see how the Planner would classify them:</p>
                
                <div class="interactive-demo">
                    <h3>Query Classifier Simulator</h3>
                    <input type="text" class="demo-input" id="queryInput" placeholder="Enter a query (e.g., 'What stocks do I own?')">
                    <button class="interactive-button" onclick="classifyQuery()">Analyze Query</button>
                    <div class="demo-output" id="queryOutput">
                        <p><em>Enter a query above and click "Analyze Query" to see the classification...</em></p>
                    </div>
                </div>
            </div>

            <!-- KEY TAKEAWAYS SECTION -->
            <div class="section">
                <h2><span class="icon">üí°</span> Key Takeaways</h2>
                
                <div class="feature-grid">
                    <div class="feature-card">
                        <h4>üéØ Planner Node</h4>
                        <ul style="list-style-position: inside;">
                            <li>FIRST agent in workflow</li>
                            <li>Interprets user intent</li>
                            <li>Understands conversation context</li>
                            <li>Activates appropriate agents</li>
                            <li>Distinguishes info vs advice requests</li>
                        </ul>
                    </div>

                    <div class="feature-card">
                        <h4>‚úÖ Validator Node</h4>
                        <ul style="list-style-position: inside;">
                            <li>LAST agent in workflow</li>
                            <li>Detects ambiguous queries</li>
                            <li>Checks data sufficiency</li>
                            <li>Prevents hallucinations</li>
                            <li>Ensures response quality</li>
                        </ul>
                    </div>

                    <div class="feature-card">
                        <h4>üîÑ Together They Ensure</h4>
                        <ul style="list-style-position: inside;">
                            <li>Correct agents are activated</li>
                            <li>Responses are factually accurate</li>
                            <li>Users get relevant information</li>
                            <li>System doesn't make up data</li>
                            <li>Quality control at every step</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <p><strong>Portfolio Intelligence System</strong></p>
            <p>LangGraph Multi-Agent Workflow with Intelligent Planning & Validation</p>
            <p style="margin-top: 10px; opacity: 0.7;">¬© 2025 | Built with LangChain & LangGraph</p>
        </footer>
    </div>

    <script>
        function classifyQuery() {
            const query = document.getElementById('queryInput').value.toLowerCase();
            const output = document.getElementById('queryOutput');
            
            if (!query) {
                output.innerHTML = '<p style="color: #ef4444;">Please enter a query first!</p>';
                return;
            }

            let needsPortfolio = false;
            let needsMarket = false;
            let wantsRecommendations = false;
            let reasoning = '';

            // Portfolio keywords
            const portfolioKeywords = ['own', 'my stocks', 'my portfolio', 'holdings', 'what do i have', 'total value'];
            if (portfolioKeywords.some(keyword => query.includes(keyword))) {
                needsPortfolio = true;
                reasoning += 'üîπ Detected portfolio-related keywords<br>';
            }

            // Market keywords
            const marketKeywords = ['price', 'market', 'trading', 'how is', 'performing', 'news'];
            if (marketKeywords.some(keyword => query.includes(keyword))) {
                needsMarket = true;
                reasoning += 'üîπ Detected market-related keywords<br>';
            }

            // Recommendation keywords
            const recommendationKeywords = ['should i', 'recommend', 'advice', 'how to improve', 'what should', 'optimize'];
            if (recommendationKeywords.some(keyword => query.includes(keyword))) {
                wantsRecommendations = true;
                reasoning += 'üîπ Detected recommendation/advice request<br>';
            }

            // If mentions "my" with stock keywords, need both
            if (query.includes('my') && (query.includes('stock') || query.includes('holding'))) {
                needsPortfolio = true;
                needsMarket = true;
                reasoning += 'üîπ Query about user\'s specific holdings requires both portfolio and market data<br>';
            }

            // Generate output
            output.innerHTML = `
                <h4 style="color: #2a5298; margin-bottom: 15px;">üìä Classification Results:</h4>
                <p><strong>Query:</strong> "${query}"</p>
                <p style="margin-top: 15px;"><strong>Reasoning:</strong><br>${reasoning || 'No specific keywords detected'}</p>
                <div style="margin-top: 20px;">
                    <span class="badge ${needsPortfolio ? 'badge-success' : 'badge-error'}">
                        needs_portfolio = ${needsPortfolio ? 'TRUE' : 'FALSE'}
                    </span>
                    <span class="badge ${needsMarket ? 'badge-success' : 'badge-error'}">
                        needs_market = ${needsMarket ? 'TRUE' : 'FALSE'}
                    </span>
                    <span class="badge ${wantsRecommendations ? 'badge-warning' : 'badge-error'}">
                        wants_recommendations = ${wantsRecommendations ? 'TRUE' : 'FALSE'}
                    </span>
                </div>
                <div style="margin-top: 20px; padding: 15px; background: #f0f9ff; border-left: 4px solid #667eea; border-radius: 5px;">
                    <strong>üéØ What This Means:</strong><br>
                    ${needsPortfolio ? '‚úÖ Portfolio Agent will be activated<br>' : ''}
                    ${needsMarket ? '‚úÖ Market Agent will be activated<br>' : ''}
                    ${wantsRecommendations ? '‚ö†Ô∏è Response will include recommendations with disclaimers<br>' : '‚úÖ Response will be informational only<br>'}
                    ${!needsPortfolio && !needsMarket ? '‚ùå No agents will be activated - query might be too general' : ''}
                </div>
            `;
        }

        // Allow Enter key to submit
        document.getElementById('queryInput').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                classifyQuery();
            }
        });
    </script>
</body>
</html>
